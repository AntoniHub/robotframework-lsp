// To test: gradlew clean test
// To build: gradlew buildPlugin
// Check all tasks: gradlew tasks

plugins {
    id 'java'
    id 'org.jetbrains.intellij' version '0.6.5'
}

publishPlugin {
    token = System.getenv("ORG_GRADLE_PROJECT_intellijPublishToken")
}

group 'robotframework.intellij'
version '0.43.2'

task finishBuild(type: Exec) {
    def finishArgs = ['python', "finish_build.py"]
    commandLine finishArgs
}

buildPlugin.finalizedBy finishBuild

repositories {
    mavenCentral()

    maven {
        url "https://oss.sonatype.org/content/repositories/snapshots/"
    }
}

allprojects {
    apply plugin: 'java'
    sourceCompatibility = 11
    targetCompatibility = 11
}

dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine'
    compile group: 'org.eclipse.lsp4j', name: 'org.eclipse.lsp4j', version: '0.12.0'
    compile group: 'org.eclipse.lsp4j', name: 'org.eclipse.lsp4j.debug', version: '0.12.0'
    compile 'org.markdownj:markdownj-core:0.4'
}

// See https://github.com/JetBrains/gradle-intellij-plugin/
intellij {
    version '2020.3'
}

patchPluginXml {
    changeNotes """
    <p>
    Release 0.43.2
    </p>
    <li>Additional fix in cache invalidation for dependencies.</li>
    <p>
    Release 0.43.0
    </p>
    <ul>
  
    <li>Improvements dealing with <strong>Variables</strong>:</li>
        <li>Undefined variables are now reported.</li>
            <li><strong>robot.variables</strong>: may be used to specify variables used for launching as well as code-completion/code analysis.</li>
            <li><strong>robot.lint.ignoreVariables</strong>: may be used to set variables to be ignored in linting.</li>
            <li><strong>robot.loadVariablesFromArgumentsFile</strong> may be used to load variables from an arguments file for code-completion and code analysis.</li>
                <li>Note: the arguments file still needs to be separately set during launching too.</li>
            <li>Variables are recognized in expressions as well as inner variables.</li>
        <li>Variables set with the following keywords are recognized:</li>
            <li>Set Task Variable</li>
            <li>Set Test Variable</li>
            <li>Set Suite Variable</li>
            <li>Set Global Variable</li>
        <li>Variable files with a <strong>.yml</strong> are properly recognized (previously only <strong>.yaml</strong> was supported). </li>
        <li>Semantic highlighting properly deals with advanced variable syntax (with variables inside variables or using a subscript).</li>
        <li>Variables in assign now have the same color as variables in other places.</li>
        <li>Variable imports which can't be resolved are reported.</li>
            <li>May be disabled with <strong>robot.lint.undefinedVariableImports</strong>.</li>
    <li>Fix issue in cache invalidation for dependencies.</li>
    <li><strong>&#47;&#47;</strong> is escaped to <strong>&#47;</strong> when passed in the library arguments.</li>
    <li>Fix in heuristics to match arguments which could result in wrong argument analysis in keyword calls.</li>
    <li>Hover now provides custom hints for variables, imports and parameters.</li>
    <li>Code-lenses are no longer shown by default.</li>
        <li>The <strong>robot.codeLens.enable</strong> setting may be used to re-enable them.</li>

    <br>
    Current feature set:<br>
    <ul>
    <li>Settings page for the language server</li>
    <li>Code completion</li>
    <li>Code analysis</li>
    <li>Go to definition</li>
    <li>Hover</li>
    <li>Code folding</li>
    <li>Browse Keywords (symbols)</li>
    <li>Syntax highlighting (with <strong>semanticTokens/full</strong> request)</li>
    <li>Debugger:</li>
    <ul>    
      <li>Add line breakpoints in <strong>.robot</strong> or <strong>.py</strong> files.</li>
      <li>Break when an error or failure is logged with the following environment variables:</li>
      <ul>
        <li><strong>RFLS_BREAK_ON_FAILURE=1</strong></li>
        <li><strong>RFLS_BREAK_ON_ERROR=1</strong></li>
      </ul>
      <li>Evaluate keywords.</li>
      <li>Pause at breakpoints to inspect the stack and see variables.</li>
      <li>Step in.</li>
      <li>Step over.</li>
      <li>Step return.</li>
      <li>Continue.</li>
    </ul>    

    </ul>
    <br>
    <strong>
    Important: The Intellij Language Server integration is currently in alpha for early access.<br>
    Please report any issues found during testing at:<br>
    <br>
    <a href="https://github.com/robocorp/robotframework-lsp/issues">https://github.com/robocorp/robotframework-lsp/issues</a>.
    </strong>
      """

    // See https://plugins.jetbrains.com/docs/intellij/gradle-guide.html?from=jetbrains.org#common-gradle-plugin-configurations-for-development
    // See https://plugins.jetbrains.com/docs/intellij/build-number-ranges.html?from=jetbrains.org#intellij-platform-based-products-of-recent-ide-versions

    sinceBuild '203'
    untilBuild '213.*'
}

test {
    useJUnit()

    systemProperty 'NO_FS_ROOTS_ACCESS_CHECK', true
    systemProperty 'idea.ProcessCanceledException', 'disabled'

    testLogging {
        // Show that tests are run in the command-line output
        events 'started', 'passed'
        showStandardStreams true
    }
}